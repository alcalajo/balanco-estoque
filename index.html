<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Balan√ßo de Estoque</title>
  <style>
    body {
      font-family: sans-serif;
      background-color: #f8f8f8;
      margin: 0;
      padding: 10px;
      text-align: center;
    }
    #reader {
      width: 100%;
      max-width: 320px;
      margin: 0 auto;
      aspect-ratio: 1/1;
      border: 3px solid #4caf50;
      border-radius: 12px;
      overflow: hidden;
    }
    #skuDisplay {
      font-size: 1.6em;
      font-weight: bold;
      margin-top: 10px;
    }
    #productImage {
      margin-top: 10px;
      max-width: 300px;
      width: 60%;
      height: auto;
      border-radius: 10px;
      border: 1px solid #ccc;
    }
    #estoqueInfo {
      margin-top: 10px;
      font-size: 1.2em;
      line-height: 1.6;
    }
    #quantidade {
      font-size: 1.4em;
      padding: 10px;
      width: 100%;
      max-width: 160px;
      margin-top: 15px;
      border-radius: 6px;
      border: 1px solid #999;
    }
    #enviar {
      margin-top: 10px;
      font-size: 1.4em;
      padding: 10px 20px;
      background-color: #4caf50;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
    }
    #mensagem {
      margin-top: 15px;
      font-weight: bold;
      font-size: 1.2em;
    }
  </style>
</head>
<body>
  <h2>Leitor de QR Code</h2>
  <div id="reader"></div>
  <div id="skuDisplay"></div>
  <img id="productImage" style="display:none;" />
  <div id="estoqueInfo"></div>
  <input type="number" id="quantidade" placeholder="Quantidade" />
  <button id="enviar">Enviar</button>
  <div id="mensagem"></div>

  <audio id="successSound" src="https://cdn.pixabay.com/download/audio/2022/03/15/audio_604adddcd2.mp3?filename=success-1-6297.mp3"></audio>

  <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
  <script>
    const reader = new Html5Qrcode("reader");
    const skuDisplay = document.getElementById("skuDisplay");
    const quantidadeInput = document.getElementById("quantidade");
    const enviarBtn = document.getElementById("enviar");
    const mensagem = document.getElementById("mensagem");
    const productImage = document.getElementById("productImage");
    const estoqueInfo = document.getElementById("estoqueInfo");
    const successSound = document.getElementById("successSound");

    let currentSku = "";

    function beep() {
      successSound.play();
    }

    function consultarEstoque(sku) {
      skuDisplay.textContent = "Consultando estoque...";
      productImage.style.display = "none";
      estoqueInfo.textContent = "";
      quantidadeInput.value = "";
      mensagem.textContent = "";

      fetch("https://atendimento-n8n.qirbea.easypanel.host/webhook/consulta-instantanea", {
        method: "POST",
        headers: {
          "Content-Type": "application/json"
        },
        body: JSON.stringify({ tipo: "consulta", sku })
      })
        .then(response => response.json())
        .then(data => {
          skuDisplay.textContent = data.codigo;
          estoqueInfo.innerHTML = `
            üì¶ <strong>Estoque atual:</strong> ${data.saldo_total} unidades<br>
            üìå <strong>Reservado:</strong> ${data.saldo_reservado}<br>
            üìç <strong>Localiza√ß√£o:</strong> ${data.localizacao || "N/D"}
          `;
          if (data.imagem) {
            productImage.src = data.imagem;
            productImage.style.display = "block";
          }
          beep();
          quantidadeInput.focus();
        })
        .catch(err => {
          skuDisplay.textContent = "Erro ao consultar estoque";
          console.error(err);
        });
    }

    function enviarQuantidade() {
      const quantidade = quantidadeInput.value.trim();
      if (!currentSku || !quantidade) {
        mensagem.textContent = "Preencha o SKU e a quantidade.";
        return;
      }

      fetch("https://atendimento-n8n.qirbea.easypanel.host/webhook/balanco", {
        method: "POST",
        headers: {
          "Content-Type": "application/json"
        },
        body: JSON.stringify({
          tipo: "balanco",
          sku: currentSku,
          quantidade: parseInt(quantidade)
        })
      })
        .then(() => {
          mensagem.textContent = "‚úÖ Enviado com sucesso!";
          quantidadeInput.value = "";
          quantidadeInput.focus();
        })
        .catch(() => {
          mensagem.textContent = "Erro ao enviar.";
        });
    }

    reader.start(
      { facingMode: "environment" },
      {
        fps: 10,
        qrbox: { width: 250, height: 250 }
      },
      (decodedText) => {
        if (decodedText !== currentSku) {
          currentSku = decodedText;
          consultarEstoque(currentSku);
        }
      }
    );

    enviarBtn.addEventListener("click", enviarQuantidade);
  </script>
</body>
</html>
